<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cusco Reporta – Mapa de Incidencias (Admin)</title>

  <!-- -->
  <link rel="stylesheet" href="../css/style.css" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root{
      --burgundy:#7a0000; --burgundy-2:#8b1e1e;
      --ink:#0f172a; --bord:#e5e7eb; --shadow:0 14px 28px rgba(0,0,0,.12);
      --rojo:#dc2626; --amarillo:#f59e0b; --verde:#16a34a; --gris:#f8fafc;
      --radius:14px;
    }
    /* Fondo granate y barra superior */
    body{margin:0;background:linear-gradient(180deg,#7a0000 0%, #5e0c0c 34%, #3a0b0b 100%); font:16px/1.5 system-ui,Segoe UI,Roboto,Arial; color:#111}
    .topbar{background:#e6e7e9;border-bottom:1px solid #d7d9de;padding:8px 18px;display:grid;grid-template-columns:auto 1fr;gap:18px;align-items:center}
    .logos{display:flex;gap:12px;align-items:center}
    .logos img{height:34px}
    .nav{display:flex;gap:26px;justify-content:flex-end}
    .nav a{color:#111;text-decoration:none;font-weight:700}
    .nav a:hover{color:var(--burgundy)}

    main{padding:22px}
    .wrap{display:grid;gap:16px;grid-template-columns: 1fr}
    .card{background:#fff;border:1px solid var(--bord);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
    h1{color:#fff;margin:6px 0 12px;font-weight:900}

    .grid{display:grid;gap:16px;grid-template-columns: 1fr 360px}
    @media (max-width:1024px){ .grid{grid-template-columns:1fr} }

    /* Panel lateral (filtros + resumen) */
    .filters label{font-weight:800;font-size:.92rem}
    .filters select{width:100%;padding:10px 12px;border:1.5px solid #d7dbe0;border-radius:10px}
    .btn{background:var(--burgundy);color:#fff;border:none;border-radius:10px;padding:10px 16px;font-weight:800;cursor:pointer}
    .btn:hover{background:var(--burgundy-2)}
    .summary{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
    .stat{border:1px solid var(--bord);border-radius:12px;padding:10px;text-align:center}
    .stat h3{margin:0;font-size:.9rem;color:#475569}
    .n{margin-top:6px;font-size:20px;font-weight:900}

    /* Mapa y leyenda */
    #map{height:72vh; min-height:460px; border-radius:12px; border:1px solid var(--bord)}
    .legend{background:#fff;border:1px solid var(--bord);border-radius:10px;padding:8px 10px;line-height:18px;box-shadow:var(--shadow)}
    .dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:6px;vertical-align:middle}
    .dot.red{background:var(--rojo)} .dot.yellow{background:var(--amarillo)} .dot.green{background:var(--verde)}

    /* Chips de estado */
    .chip{display:inline-block;padding:4px 10px;border-radius:999px;font-weight:800;font-size:.85rem;color:#fff}
    .chip.red{background:var(--rojo)} .chip.yellow{background:var(--amarillo);color:#111} .chip.green{background:var(--verde)}
  </style>
</head>
<body>
  <!-- TOPBAR -->
  <header class="topbar">
    <div class="logos">
      <img src="../assents/images/MTC.png" alt="MTC">
      <img src="../assents/images/CuscoReporta.png" alt="Cusco Reporta">
    </div>
    <nav class="nav">
      <a href="index.html">Inicio</a>
      <a href="panel.html">Registra tu denuncia</a>
      <a href="Estado_Reporte.html">Estado de reportes</a>
      <a href="iniciar-sesion.html">Iniciar Sesión</a>
      <a href="#">Ayuda</a>
    </nav>
  </header>

  <main>
    <h1>Mapa de Incidencias (Admin)</h1>

    <div class="grid">
      <!-- MAPA -->
      <section class="card">
        <div id="map"></div>
      </section>

      <!-- PANEL LATERAL -->
      <aside class="card">
        <h3 style="margin-top:4px">Filtros</h3>
        <div class="filters">
          <label for="fEstado">Estado</label>
          <select id="fEstado">
            <option value="TODOS">Todos</option>
            <option value="Recibido">Recibido (rojo)</option>
            <option value="En proceso">En proceso (amarillo)</option>
            <option value="Solucionado">Solucionado (verde)</option>
          </select>
          <button id="btnAplicar" class="btn" style="margin-top:10px">Aplicar filtro</button>
        </div>

        <div style="margin-top:16px">
          <div class="legend">
            <div><span class="dot red"></span>Recibido</div>
            <div><span class="dot yellow"></span>En proceso</div>
            <div><span class="dot green"></span>Solucionado</div>
          </div>
        </div>

        <div class="summary">
          <div class="stat"><h3>Recibidos</h3><div class="n" id="c-reci">0</div></div>
          <div class="stat"><h3>En proceso</h3><div class="n" id="c-proc">0</div></div>
          <div class="stat"><h3>Solucionados</h3><div class="n" id="c-solu">0</div></div>
        </div>

        <div style="margin-top:16px">
          <h3 style="margin:8px 0">Seleccionado</h3>
          <div id="detalle">
            <div><b>ID:</b> <span id="d-id">—</span></div>
            <div><b>Fecha:</b> <span id="d-fecha">—</span></div>
            <div><b>Estado:</b> <span id="d-estado">—</span></div>
            <div><b>Tipo:</b> <span id="d-tipo">—</span></div>
            <div><b>Dirección:</b> <span id="d-dir">—</span></div>
            <div style="margin-top:8px;color:#64748b;font-size:.9rem">* Datos simulados para prototipo.</div>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <script>
    // ===================== Datos simulados =====================
    // Coordenadas aproximadas de Cusco
    const INCIDENTES = [
      { id:1052, fecha:'2024-04-20', estado:'Recibido',     tipo:'Accidente',           dir:'Av. El Sol 500',     lat:-13.5185, lng:-71.9769 },
      { id:1048, fecha:'2024-04-18', estado:'En proceso',   tipo:'Semáforo dañado',     dir:'Calle Pumacurco 210', lat:-13.5176, lng:-71.9740 },
      { id:1034, fecha:'2024-04-15', estado:'Solucionado',  tipo:'Mal estacionamiento', dir:'Jirón Santiago 320',  lat:-13.5240, lng:-71.9795 },
      { id:1027, fecha:'2024-04-13', estado:'Solucionado',  tipo:'Obstrucción de vía',  dir:'Calle Mantas 120',    lat:-13.5189, lng:-71.9799 },
      { id:1013, fecha:'2024-04-10', estado:'En proceso',   tipo:'Señal caída',         dir:'Av. Garcilaso 1204',  lat:-13.5226, lng:-71.9678 },
      { id:1009, fecha:'2024-04-08', estado:'Recibido',     tipo:'Accidente',           dir:'Calle Hospital 50',   lat:-13.5153, lng:-71.9752 },
      { id:1003, fecha:'2024-04-06', estado:'Recibido',     tipo:'Congestión',          dir:'Av. de la Cultura',   lat:-13.5220, lng:-71.9588 },
      { id:1001, fecha:'2024-04-05', estado:'Solucionado',  tipo:'Hueco en vía',        dir:'Urb. Ttio D-12',      lat:-13.5270, lng:-71.9487 }
    ];

    // ===================== UI helpers =====================
    const $ = (s, r=document)=>r.querySelector(s);
    const colorByEstado = (e)=> e==='Recibido' ? '#dc2626' : e==='En proceso' ? '#f59e0b' : '#16a34a';
    const chip = (e)=> {
      const cls = e==='Recibido' ? 'red' : e==='En proceso' ? 'yellow' : 'green';
      return `<span class="chip ${cls}">${e}</span>`;
    };

    function updateCounters(list){
      $('#c-reci').textContent = list.filter(x=>x.estado==='Recibido').length;
      $('#c-proc').textContent = list.filter(x=>x.estado==='En proceso').length;
      $('#c-solu').textContent = list.filter(x=>x.estado==='Solucionado').length;
    }

    function setDetalle(r){
      $('#d-id').textContent = r ? r.id : '—';
      $('#d-fecha').textContent = r ? r.fecha : '—';
      $('#d-estado').innerHTML = r ? chip(r.estado) : '—';
      $('#d-tipo').textContent = r ? r.tipo : '—';
      $('#d-dir').textContent = r ? r.dir : '—';
    }

    // ===================== Mapa =====================
    let map, markersLayer;

    function initMap(){
      map = L.map('map').setView([-13.518, -71.975], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);
      markersLayer = L.layerGroup().addTo(map);
    }

    function renderMarkers(list){
      markersLayer.clearLayers();
      if(!list.length) return;

      const bounds = [];
      list.forEach(r=>{
        const marker = L.circleMarker([r.lat, r.lng], {
          radius: 9,
          color: '#111',
          weight: 1,
          fillColor: colorByEstado(r.estado),
          fillOpacity: .9
        })
        .bindPopup(`
          <b>ID ${r.id}</b><br>
          ${r.tipo}<br>
          ${r.dir}<br>
          ${chip(r.estado)} · ${r.fecha}
        `)
        .on('click', ()=> setDetalle(r));
        marker.addTo(markersLayer);
        bounds.push([r.lat, r.lng]);
      });

      // Enfocar a los resultados
      if(bounds.length===1){ map.setView(bounds[0], 16); }
      else{ map.fitBounds(bounds, { padding:[24,24] }); }
    }

    function applyFilter(){
      const estado = $('#fEstado').value; // TODOS | Recibido | En proceso | Solucionado
      const filtered = estado==='TODOS' ? INCIDENTES : INCIDENTES.filter(x=>x.estado===estado);
      renderMarkers(filtered);
      updateCounters(filtered);
      setDetalle(filtered[0] || null);
    }

    // ===================== Init =====================
    window.addEventListener('DOMContentLoaded', ()=>{
      initMap();
      // eventos
      $('#btnAplicar').addEventListener('click', applyFilter);
      $('#fEstado').addEventListener('change', applyFilter);
      // render inicial
      applyFilter();
    });
  </script>
</body>
</html>
